#!/usr/bin/env node

const os = require('os');
const fs = require('fs');
const path = require('path');

function getLocalIP() {
  const interfaces = os.networkInterfaces();

  for (const name of Object.keys(interfaces)) {
    for (const iface of interfaces[name]) {
      // ä¼˜å…ˆè¿”å› en0ï¼ˆMacOSï¼‰æˆ– Ethernet/Wi-Fi çš„ IPv4 åœ°å€
      if (!iface.internal && iface.family === 'IPv4') {
        if (name === 'en0' || name === 'en1' || name === 'Wi-Fi' || name === 'Ethernet') {
          return iface.address;
        }
      }
    }
  }

  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªéå†…éƒ¨ IPv4 åœ°å€
  for (const name of Object.keys(interfaces)) {
    for (const iface of interfaces[name]) {
      if (!iface.internal && iface.family === 'IPv4') {
        return iface.address;
      }
    }
  }

  return 'localhost';
}

function createConfigFile() {
  const ip = getLocalIP();
  const fileName = 'rn-remote-debug.js';
  const filePath = path.join(process.cwd(), fileName);

  // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
  if (fs.existsSync(filePath)) {
    console.log(`\nâš ï¸  ${fileName} already exists in this directory\n`);
    console.log('Current location:', filePath);
    console.log('\nIf you want to recreate it, please delete the existing file first.\n');
    process.exit(1);
  }

  // ç”Ÿæˆé…ç½®æ–‡ä»¶å†…å®¹
  const content = `// RN Remote Debugger Configuration
// This file was auto-generated by npx rn-remote-debugger-create

if (__DEV__) {
  module.exports = {
    host: '${ip}', // Your development machine's IP address
    port: 8989,    // WebSocket port
    enableConsole: true,  // Enable console interception
    enableNetwork: true   // Enable network interception
  };
} else {
  module.exports = {};
}
`;

  // å†™å…¥æ–‡ä»¶
  try {
    fs.writeFileSync(filePath, content, 'utf8');
    console.log('\nâœ… Configuration file created successfully!\n');
    console.log(`File: ${fileName}`);
    console.log(`Location: ${filePath}\n`);
    console.log('ğŸ“ Configuration:');
    console.log(`  Host: ${ip}`);
    console.log(`  Port: 8989\n`);
    console.log('ğŸ’¡ Next steps:\n');
    console.log('  1. For Android devices, run:');
    console.log(`     adb reverse tcp:8989 tcp:8989\n`);
    console.log('  2. Start your React Native app\n');
    console.log('  3. The debugger will automatically connect\n');
  } catch (error) {
    console.error('\nâŒ Failed to create configuration file:', error.message, '\n');
    process.exit(1);
  }
}

function main() {
  createConfigFile();
}

main();
